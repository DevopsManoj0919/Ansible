- hosts: tomcatServers
  become: true
  vars:
      tomcatScripts:
       - /opt/tomcat/bin/startup.sh
       - /opt/tomcat/bin/shutdown.sh
       - /opt/tomcat/bin/catalina.sh
  tasks:
    - name: Install Java OpenJDK 11
      get_url:
        url: https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_linux-x64_bin.tar.gz
        dest: /opt/openjdk-11.0.2_linux-x64_bin.tar.gz
    - name: Extract Java OpenJDK 11
      unarchive:
        src: /opt/openjdk-11.0.2_linux-x64_bin.tar.gz
        dest: /opt/
        remote_src: yes
    - name: Rename Java directory
      command: mv /opt/jdk-11.0.2 /opt/java-11
      args:
        creates: /opt/java-11
    - name: Set JAVA_HOME and update PATH
      lineinfile:
        path: /etc/profile
        line: "{{ item }}"
        create: yes
      with_items:
        - "export JAVA_HOME=/opt/java-11"
        - "export PATH=$PATH:$JAVA_HOME/bin"
    - name: create symlink for java
      file:
        src: /opt/java-11/bin/java
        dest: /usr/bin/java
        state: link
    - name: Verify Java installation
      command: java -version


    - name: Download Apache Tomcat
      get_url:
        url: https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.58/bin/apache-tomcat-9.0.58.tar.gz
        dest: /opt/apache-tomcat-9.0.58.tar.gz

    - name: Extract Apache Tomcat
      unarchive:
        src: /opt/apache-tomcat-9.0.58.tar.gz
        dest: /opt/
        remote_src: yes

    - name: Rename Tomcat directory
      command: mv /opt/apache-tomcat-9.0.58 /opt/tomcat
      args:
        creates: /opt/tomcat
    - name: remove tomcat tar file
      file:
        path: /opt/apache-tomcat-9.0.58.tar.gz
        state: absent
    - name: set permissions
      command: chown -R ec2-user:ec2-user /opt/tomcat
    - name: set executable permissions for tomcat scripts
      file:
        path: "{{ item }}"
        mode: 'u+x'
      with_items:
        - "{{ tomcatScripts }}"


    - name: copy tomcat service file
      copy:
        src: tomcat.service
        dest: /etc/systemd/system/tomcat.service


    - name: Reload systemd daemon
      service:
        daemon_reload: yes
      notify: show tomcat
  handlers:
    - name: show tomcat
      command: sudo systemctl status tomcat
      register: tomcatStatus
      listen: show tomcat
      changed_when: true
    - name: show tomcat status
      debug:
       var: tomcatStatus





       
       - name: Move folder from tomcat folder
      ansible.builtin.command:
        cmd: mv /opt/apache-tomcat-9.0.112 /opt/tomcat
      args:
        removes: /opt/apache-tomcat-9.0.112
        creates: /opt/tomcat
   

    - name: remove tomcat tar,gz file
      ansible.builtin.file: 
        path: "{{ item  }}"
        state: absent
      loop:
        "{{ Removezipfilenames }}"


    - name: Set permissions to ec2users
      ansible.builtin.file:
        path: /opt/tomcat
        owner: ec2-user
        group: ec2-user
        recurse: yes
    
    - name: Ensure *.sh is executable
      ansible.builtin.file:
        path: "{{ item }}"
        mode: '0755'
      loop:
        - /opt/tomcat/bin/catalina.sh
        - /opt/tomcat/bin/startup.sh
        - /opt/tomcat/bin/shutdown.sh
       

    - name: Create Tomcat systemd service file
      ansible.builtin.copy:
        dest: /etc/systemd/system/tomcat.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=Apache Tomcat 9 Web Application Container
          After=network.target

          [Service]
          Type=forking
          User=ec2-user
          Group=ec2-user
          Environment="JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))"
          Environment="CATALINA_PID=/opt/tomcat/temp/tomcat.pid"
          Environment="CATALINA_HOME=/opt/tomcat"
          Environment="CATALINA_BASE=/opt/tomcat"
          ExecStart=/opt/tomcat/bin/startup.sh
          ExecStop=/opt/tomcat/bin/shutdown.sh
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target

    - name: Start and enable Tomcat service
      ansible.builtin.systemd:
        name: tomcat
        state: started
        enabled: yes

    - name: Gather service facts
      ansible.builtin.service_facts:

    - name: Show Tomcat service status
      ansible.builtin.debug:
        var: ansible_facts.services['tomcat.service']



